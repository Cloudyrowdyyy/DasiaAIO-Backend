use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use uuid::Uuid;

// User role enum
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, sqlx::Type)]
#[sqlx(type_name = "varchar")]
pub enum UserRole {
    #[serde(rename = "user")]
    User,
    #[serde(rename = "admin")]
    Admin,
    #[serde(rename = "superadmin")]
    Superadmin,
}

impl std::fmt::Display for UserRole {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            UserRole::User => write!(f, "user"),
            UserRole::Admin => write!(f, "admin"),
            UserRole::Superadmin => write!(f, "superadmin"),
        }
    }
}

impl std::str::FromStr for UserRole {
    type Err = String;

    fn from_str(s: &str) -> Result<Self, Self::Err> {
        match s {
            "user" => Ok(UserRole::User),
            "admin" => Ok(UserRole::Admin),
            "superadmin" => Ok(UserRole::Superadmin),
            _ => Err(format!("Unknown role: {}", s)),
        }
    }
}

// User model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct User {
    pub id: String,
    pub email: String,
    pub username: String,
    #[serde(skip_serializing)]
    pub password: String,
    pub role: String,
    pub full_name: String,
    pub phone_number: String,
    pub license_number: Option<String>,
    pub license_expiry_date: Option<DateTime<Utc>>,
    pub profile_photo: Option<String>,
    pub verified: bool,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

// User creation request
#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CreateUserRequest {
    pub email: String,
    pub password: String,
    pub username: String,
    pub role: String,
    pub full_name: String,
    pub phone_number: String,
    pub license_number: Option<String>,
    pub license_expiry_date: Option<DateTime<Utc>>,
    pub admin_code: Option<String>,
}

// User response (without password)
#[derive(Debug, Serialize)]
pub struct UserResponse {
    pub id: String,
    pub email: String,
    pub username: String,
    pub role: String,
    pub full_name: String,
    pub phone_number: String,
    pub profile_photo: Option<String>,
}

impl From<User> for UserResponse {
    fn from(user: User) -> Self {
        UserResponse {
            id: user.id,
            email: user.email,
            username: user.username,
            role: user.role,
            full_name: user.full_name,
            phone_number: user.phone_number,
            profile_photo: user.profile_photo,
        }
    }
}

// Verification model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct Verification {
    pub id: String,
    pub user_id: String,
    pub code: String,
    pub expires_at: DateTime<Utc>,
    pub created_at: DateTime<Utc>,
}

// Firearm status enum
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq)]
#[serde(rename_all = "lowercase")]
pub enum FirearmStatus {
    Available,
    Allocated,
    Maintenance,
}

impl std::fmt::Display for FirearmStatus {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            FirearmStatus::Available => write!(f, "available"),
            FirearmStatus::Allocated => write!(f, "allocated"),
            FirearmStatus::Maintenance => write!(f, "maintenance"),
        }
    }
}

// Firearm model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct Firearm {
    pub id: String,
    pub name: String,
    pub serial_number: String,
    pub model: String,
    pub caliber: String,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CreateFirearmRequest {
    pub serial_number: String,
    pub model: String,
    pub caliber: String,
    pub status: Option<String>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct UpdateFirearmRequest {
    pub status: Option<String>,
    pub caliber: Option<String>,
}

// Firearm Allocation model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct FirearmAllocation {
    pub id: String,
    pub guard_id: String,
    pub firearm_id: String,
    pub allocation_date: DateTime<Utc>,
    pub return_date: Option<DateTime<Utc>>,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct IssueFirearmRequest {
    pub firearm_id: String,
    pub guard_id: String,
    pub notes: Option<String>,
}

#[derive(Debug, Deserialize)]
pub struct ReturnFirearmRequest {
    pub allocation_id: String,
}

// Attendance model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct Attendance {
    pub id: String,
    pub guard_id: String,
    pub shift_id: String,
    pub check_in_time: DateTime<Utc>,
    pub check_out_time: Option<DateTime<Utc>>,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

// Authentication requests
#[derive(Debug, Deserialize)]
pub struct LoginRequest {
    pub identifier: String,
    pub password: String,
}

#[derive(Debug, Deserialize)]
pub struct VerifyEmailRequest {
    pub email: String,
    pub code: String,
}

#[derive(Debug, Deserialize)]
pub struct ResendCodeRequest {
    pub email: String,
}

// Guard Replacement related models
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct Shift {
    pub id: String,
    pub guard_id: String,
    pub start_time: DateTime<Utc>,
    pub end_time: DateTime<Utc>,
    pub client_site: String,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CreateShiftRequest {
    pub guard_id: String,
    pub start_time: String,
    pub end_time: String,
    pub client_site: String,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CheckInRequest {
    pub guard_id: String,
    pub shift_id: String,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CheckOutRequest {
    pub attendance_id: String,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct RequestReplacementRequest {
    pub original_guard_id: String,
    pub replacement_guard_id: String,
    pub shift_id: String,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct SetAvailabilityRequest {
    pub guard_id: String,
    pub available: Option<bool>,
    pub available_from: Option<DateTime<Utc>>,
    pub available_to: Option<DateTime<Utc>>,
    pub notes: Option<String>,
}
// Armored Car models
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct ArmoredCar {
    pub id: String,
    pub license_plate: String,
    pub vin: String,
    pub model: String,
    pub manufacturer: String,
    pub capacity_kg: i32,
    pub status: String,
    pub registration_expiry: Option<DateTime<Utc>>,
    pub insurance_expiry: Option<DateTime<Utc>>,
    pub last_maintenance_date: Option<DateTime<Utc>>,
    pub mileage: i32,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CreateArmoredCarRequest {
    pub license_plate: String,
    pub vin: String,
    pub model: String,
    pub manufacturer: String,
    pub capacity_kg: i32,
    pub registration_expiry: Option<DateTime<Utc>>,
    pub insurance_expiry: Option<DateTime<Utc>>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct UpdateArmoredCarRequest {
    pub status: Option<String>,
    pub mileage: Option<i32>,
    pub registration_expiry: Option<DateTime<Utc>>,
    pub insurance_expiry: Option<DateTime<Utc>>,
}

// Car Allocation model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct CarAllocation {
    pub id: String,
    pub car_id: String,
    pub client_id: String,
    pub allocation_date: DateTime<Utc>,
    pub return_date: Option<DateTime<Utc>>,
    pub expected_return_date: Option<DateTime<Utc>>,
    pub status: String,
    pub notes: Option<String>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct IssueCarRequest {
    pub car_id: String,
    pub client_id: String,
    pub expected_return_date: Option<DateTime<Utc>>,
    pub notes: Option<String>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct ReturnCarRequest {
    pub allocation_id: String,
}

// Car Maintenance model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct CarMaintenance {
    pub id: String,
    pub car_id: String,
    pub maintenance_type: String,
    pub description: String,
    pub cost: Option<String>,
    pub scheduled_date: Option<DateTime<Utc>>,
    pub completion_date: Option<DateTime<Utc>>,
    pub status: String,
    pub notes: Option<String>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CreateMaintenanceRequest {
    pub car_id: String,
    pub maintenance_type: String,
    pub description: String,
    pub scheduled_date: Option<DateTime<Utc>>,
    pub cost: Option<String>,
}

// Driver Assignment model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct DriverAssignment {
    pub id: String,
    pub car_id: String,
    pub guard_id: String,
    pub assignment_date: DateTime<Utc>,
    pub end_date: Option<DateTime<Utc>>,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct AssignDriverRequest {
    pub car_id: String,
    pub guard_id: String,
}

// Trip model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct Trip {
    pub id: String,
    pub car_id: String,
    pub driver_id: String,
    pub allocation_id: Option<String>,
    pub start_location: String,
    pub end_location: Option<String>,
    pub start_time: DateTime<Utc>,
    pub end_time: Option<DateTime<Utc>>,
    pub distance_km: Option<String>,
    pub status: String,
    pub mission_details: Option<String>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CreateTripRequest {
    pub car_id: String,
    pub driver_id: String,
    pub allocation_id: Option<String>,
    pub start_location: String,
    pub mission_details: Option<String>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct EndTripRequest {
    pub trip_id: String,
    pub end_location: String,
    pub distance_km: Option<String>,
}

// Guard permit model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct GuardFirearmPermit {
    pub id: String,
    pub guard_id: String,
    pub firearm_id: Option<String>,
    pub permit_type: String,
    pub issued_date: DateTime<Utc>,
    pub expiry_date: DateTime<Utc>,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
pub struct CreateGuardFirearmPermitRequest {
    pub guard_id: String,
    pub firearm_id: Option<String>,
    pub permit_type: String,
    pub issued_date: DateTime<Utc>,
    pub expiry_date: DateTime<Utc>,
    pub status: Option<String>,
}

// Guard allocation view with firearm details
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct GuardAllocationView {
    pub id: String,
    pub guard_id: String,
    pub firearm_id: String,
    pub allocation_date: DateTime<Utc>,
    pub return_date: Option<DateTime<Utc>>,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub firearm_model: String,
    pub firearm_caliber: String,
    pub firearm_serial_number: String,
}

// Support ticket model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct SupportTicket {
    pub id: String,
    pub guard_id: String,
    pub subject: String,
    pub message: String,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
pub struct CreateSupportTicketRequest {
    pub guard_id: String,
    pub subject: String,
    pub message: String,
}

// Notification model for web-based notification system
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
#[serde(rename_all = "camelCase")]
pub struct Notification {
    pub id: String,
    pub user_id: String,
    pub title: String,
    pub message: String,
    #[serde(rename = "type")]
    pub notification_type: String,
    pub related_shift_id: Option<String>,
    pub read: bool,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CreateNotificationRequest {
    pub user_id: String,
    pub title: String,
    pub message: String,
    #[serde(rename = "type")]
    pub notification_type: String,
    pub related_shift_id: Option<String>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct MarkNotificationReadRequest {
    pub notification_id: String,
}

// Guard availability model
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
#[serde(rename_all = "camelCase")]
pub struct GuardAvailability {
    pub id: String,
    pub guard_id: String,
    pub available: bool,
    pub available_from: Option<DateTime<Utc>>,
    pub available_to: Option<DateTime<Utc>>,
    pub notes: Option<String>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct UpdateGuardAvailabilityRequest {
    pub guard_id: String,
    pub available: bool,
    pub available_from: Option<DateTime<Utc>>,
    pub available_to: Option<DateTime<Utc>>,
    pub notes: Option<String>,
}